---
git@gitee.com:sjdt/geekhall.cn.gitlayout: post
title:  "Eureka 笔记"
date:   2021-08-08 22:10:25 +0800
categories: Eureka 微服务
---

# Eureka 服务注册与发现

## 什么是Eureka
Eureka是Netflix的一个子模块，也是核心模块之一，Eureka是一个基于REST的服务，用于服务定位、注册与发现。


## 1. 新建Eureka Server
新建SpringBoot项目，导入依赖：
```xml
<dependencies>

    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-eureka-server</artifactId>
        <version>1.4.7.RELEASE</version>
    </dependency>

    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-devtools</artifactId>
        <version>2.5.3</version>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
        <version>2.5.3</version>
    </dependency>

    <!-- eureka 依赖包，下面两个需要导入，否则启动会报ClassNotFound -->
    <dependency>
        <groupId>com.fasterxml.jackson.core</groupId>
        <artifactId>jackson-core</artifactId>
        <version>2.12.3</version>
    </dependency>

    <dependency>
        <groupId>com.google.code.gson</groupId>
        <artifactId>gson</artifactId>
        <version>2.8.7</version>
    </dependency>

</dependencies>
```

这里需要注意的是需要导入jackson和gson的依赖包，否则启动时会报错。


Spring配置文件中添加如下Eureka配置内容：
```yml
# 服务端口
server:
  port: 8015

# Eureka 配置
eureka:
  instance:
    hostname: springcloud-eureka-8015 # Eureka 服务端的实例名称
  client:
    register-with-eureka: false   # 是否向eureka注册中心注册自己
    fetch-registry: false         # fetch-registry 如果为false，表示自己为注册中心
    service-url:
      defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka/
```


主启动类添加`EnableEurekaServer`注解，表示这个类为服务端的启动类，可以接受别人注册进来。
```java
@SpringBootApplication
@EnableEurekaServer         // 服务端的启动类，可以接受别人注册进来
public class EurekaServer_8015 {
    public static void main(String[] args) {
        SpringApplication.run(EurekaServer_8015.class, args);
    }
}
```

启动服务之后，浏览器访问`http://localhost:8015/`，就可以看到服务端界面了。
![](https://yinyang.space/img/20210809_eureka_01.png)

## 2. 新建 Eureka 服务提供模块
新建 SpringBoot工程作为 Eureka 服务提供模块，并注册至Eureka

添加依赖：
```xml

```

Spring配置，中间的Mybatis和Spring配置可以忽略，重点为下面的Eureka配置服务端地址应配置为刚刚Erueka服务端的访问地址：
```yml
server:
  port: 8011

# mybatis 配置
mybatis:
  type-aliases-package: cn.geekhall.bean
  config-location: classpath:mybatis/mybatis-config.xml
  mapper-locations: classpath:mybatis/mapper/*.xml


#  Spring配置
spring:
  application:
    name: springcloud-provider-dept
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://127.0.0.1:3316/db01?useSSL=true&useUnicode=true&characterEncoding=UTF-8
    username: user01
    password: yy123456


# Eureka 配置
eureka:
  client:
    service-url:
      defaultZone: http://localhost:8015/eureka/


```

源码添加`@EnableEurekaClient`注解，启动时自动注册到Eureka。
```java
@SpringBootApplication
@EnableEurekaClient             // 服务启动时自动注册到Eureka中。
public class DeptProvider_8011 {
    public static void main(String[] args) {
        SpringApplication.run(DeptProvider_8011.class, args);
    }
}

```


启动工程后，访问Eureka可以看到，刚刚的服务已经注册到Eureka中了。

![](https://yinyang.space/img/20210809_eureka_02.png)



## Eureka的自我保护机制
在自我保护模式中，Eureka会保护服务注册表中的信息，不再注销任何实例，当它收到的心跳数重新恢复到阈值以上时，该Eureka节点会自动退出自我保护机制，他的涉及哲学就是宁可保留错误的服务注册信息，
也不盲目注销任何可能健康的服务实例，一句话：好死不如赖活着。

![](https://yinyang.space/img/20210809_eureka_03.png)



## Eureka集群
/etc/hosts中添加
```
127.0.0.1     eureka8015
127.0.0.1     eureka8016
127.0.0.1     eureka8017
```

新建三个Maven项目，配置如下：
8015
```yml
server:
  port: 8015

#Eureka 配置
eureka:
  instance:
    hostname: springcloud-eureka-8015 # Eureka 服务端的实例名称
  client:
    register-with-eureka: false  # 是否向eureka注册中心注册自己
    fetch-registry: false         # fetch-registry 如果为false，表示自己为注册中心
    service-url:      # 监控页面
      defaultZone: http://eureka8016:8016/eureka/,http://eureka8017:8017/eureka/
```

```yml
server:
  port: 8016

#Eureka 配置
eureka:
  instance:
    hostname: springcloud-eureka-8016 # Eureka 服务端的实例名称
  client:
    register-with-eureka: false  # 是否向eureka注册中心注册自己
    fetch-registry: false         # fetch-registry 如果为false，表示自己为注册中心
    service-url:
      defaultZone: http://eureka8015:8015/eureka/,http://eureka8017:8017/eureka/
```

```yml
server:
  port: 8017

#Eureka 配置
eureka:
  instance:
    hostname: springcloud-eureka-8017 # Eureka 服务端的实例名称
  client:
    register-with-eureka: false  # 是否向eureka注册中心注册自己
    fetch-registry: false         # fetch-registry 如果为false，表示自己为注册中心
    service-url:
      defaultZone: http://eureka8015:8015/eureka/,http://eureka8016:8016/eureka/
```

登录Eureka在DS Replicas可以看到Eureka集群已经配置好了：

![](https://yinyang.space/img/20210809_eureka_04.png)



## Eureka和ZooKeeper对比
CAP原则，指的是Consistency（一致性）、 Availability（可用性）、Partition tolerance（分区容错性），三者不可得兼。
* ZooKeeper保证的是CP，可以容忍注册中心返回的是几分钟以前的注册信息，但是不能接受服务直接down掉不可用。也就是说服务注册功能对可用性A的要求要高于一致性。但是zk会出现这样一种情况，当master节点因为网络故障与其他节点失去联系时，剩余节点会重新进行leader选举，30-120s，且选举期间整个zk集群都是不可用的，导致在选举期间注册服务瘫痪。而失去master节点是较大概率的事件，虽然服务最终能够恢复，但是漫长的选举时间导致服务长时间不可用是不能容忍的。
* Eureka保证的是AP，Eureka看明白了这一点，因此在设计时就优先保证可用性，Eureka各个节点都是平等的，某个节点挂掉不会影响正常工作，剩余节点依然可以提供注册和查询服务，保证了可用性A，只不过查到的信息可能不是最新的，而且Eureka还有一种自我保护机制，如果在15分钟内超过85%的节点都没有正常的心跳，那么Eureka就认为客户端与注册中心出现了网络故障，此时会出现以下几种情况：
  1. Eureka不再从注册列表中移除因为长时间没有收到心跳而应该过期的服务。
  2. Eureka仍然能够接受新服务的注册和查询请求，但是不会被同步到其他节点上。（保证当前节点依然可用）
  3. 当网络稳定时，当前实例新的注册信息会被同步到其他节点中。
   
  
  
因此Eureka可以很好的应对因为网络故障导致部分节点失去联系的情况，而不会像zookeeper那样使整个注册服务瘫痪。



## Ribbon
Spring Cloud Ribbon是一个基于HTTP和TCP的客户端负载均衡工具，它基于Netflix Ribbon实现。通过Spring Cloud的封装，可以让我们轻松地将面向服务的REST模版请求自动转换成客户端负载均衡的服务调用。Spring Cloud Ribbon虽然只是一个工具类框架，它不像服务注册中心、配置中心、API网关那样需要独立部署，但是它几乎存在于每一个Spring Cloud构建的微服务和基础设施中。因为微服务间的调用，API网关的请求转发等内容，实际上都是通过Ribbon来实现的，包括后续我们将要介绍的Feign，它也是基于Ribbon实现的工具。所以，对Spring Cloud Ribbon的理解和使用，对于我们使用Spring Cloud来构建微服务非常重要。

## Feign 负载均衡
* Feign  使用接口和注解
* Ribbon 使用微服务名字

在Feign的实现下，我们只需要创建一个接口并使用注解的方式来配置它（类似于Dao接口上标注Mapper注解，现在是一个微服务接口上标注一个Feign注解即可。）即可完成对服务提供方的借口绑定，简化了Spring Cloud Ribbon自动封装服务调用客户端的开发量。

## Hystrix
断路器，服务降级、服务熔断、服务限流、避免服务雪崩
熔断机制是对雪崩效应的一种微服务链路保护机制
当链路的某个微服务不可用或者响应时间太长时，会进行服务的降级，进而熔断该节点微服务的调用，快速返回错误的响应信息。当检测到该节点微服务调用响应正常后恢复调用链路。在SpringCloud框架里熔断机制通过Hystrix实现，Hystrix会监控微服务间调用的状况，当失败的调用到一定阈值，缺省是5秒内20次调用失败就会启用熔断机制，熔断机制的注解是`@HystrixCommand`

比如双十一的时候关闭退款服务，就属于服务降级释放资源给订单等服务。


![](https://yinyang.space/img/20210813_hystrix_01.png)

步骤
1. 新建一个Dashboard模块，添加dashboard依赖
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-hystrix-dashboard</artifactId>
    <version>1.4.6.RELEASE</version>
</dependency>
```

2. 开启Hystrix监控
```java
@SpringBootApplication
@EnableHystrixDashboard         // 开启Hystrix监控
public class DeptConsumerDashboard_9001 {
    public static void main(String[] args) {
        SpringApplication.run(DeptConsumerDashboard_9001.class, args);
    }
}
```

3. 在服务端模块中增加一个Servlet，用于映射`/actuator/hystrix.stream`
```java
// 增加一个Servlet
@Bean
public ServletRegistrationBean hystrixMetricsStreamServlet(){
    ServletRegistrationBean<HystrixMetricsStreamServlet> registrationBean = new ServletRegistrationBean<>(new HystrixMetricsStreamServlet());
    registrationBean.addUrlMappings("/actuator/hystrix.stream");
    return registrationBean;
}
```




## Zuul
Zuul包含了对请求的路由和过滤两个最主要的功能。
其中路由功能负责外部请求转发到具体的微服务实例上，是实现外部访问统一入口的基础，而过滤器功能则负责对请求的处理过程进行干预，是实现请求脚要，服务聚合等功能的基础。

Zuul和Eureka进行整合，将Zuul自身注册为Eureka服务治理下的应用，同时从Eureka中获得其他微服务的消息，也即以后的访问微服务都是通过Zuul跳转后获得。

注意：Zuul服务最终还是会注册进Eureka
提供：代理 + 路由 + 过滤 三大功能

步骤
1. 新建一个Zuul模块，添加依赖
```xml
<!-- Zuul -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-zuul</artifactId>
    <version>1.4.6.RELEASE</version>
</dependency>
```

1. 开启Zuul代理
```java
@SpringBootApplication
@EnableZuulProxy        // 开启Zuul
public class ZuulApplication_9527 {
    public static void main(String[] args) {
        SpringApplication.run(ZuulApplication_9527.class, args);
    }
}
```

application.yml
```yml
server:
  port: 9527


spring:
  application:
    name: springcloud-zuul


eureka:
  client:
    service-url:
      defaultZone: http://eureka7001:7001/eureka,http://eureka7002:7002/eureka,http://eureka7003:7003/eureka # Eureka注册中心地址
  instance:
    instance-id: zuul9527.com
    prefer-ip-address: true

info:
  app.name: geekhall-springcloud
  company.name: www.geekhall.cn


```


## SpringBoot和Spring Cloud对应版本

|Spring Cloud | Spring Boot|
|----|----|
|Angel版本|	兼容Spring Boot 1.2.x|
|Brixton版本|	兼容Spring Boot 1.3.x，也兼容Spring Boot 1.4.x|
|Camden版本|	兼容Spring Boot 1.4.x，也兼容Spring Boot 1.5.x|
|Dalston版本、Edgware版本|	兼容Spring Boot 1.5.x，不兼容Spring Boot 2.0.x|
|Finchley版本|	兼容Spring Boot 2.0.x，不兼容Spring Boot 1.5.x|
|Greenwich版本|	兼容Spring Boot 2.1.x|
|Hoxtonl版本|	兼容Spring Boot 2.2.x|


|Spring Boot	|Spring Cloud|
|----|----|
|1.5.2.RELEASE	|Dalston.RC1|
|1.5.9.RELEASE	|Edgware.RELEASE|
|2.0.2.RELEASE	|Finchley.BUILD-SNAPSHOT|
|2.0.3.RELEASE	|Finchley.RELEASE|
|2.1.0.RELEASE-2.1.14.RELEASE|	Greenwich.SR5|
|2.2.0.M4	|Hoxton.SR4|


